<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mobile Voxel Game</title>
<style>
body { margin:0; overflow:hidden; touch-action:none; }
canvas { display:block; }

#joystick {
  position: absolute; bottom: 50px; left: 50px; width:120px; height:120px;
  background: rgba(0,0,0,0.3); border-radius:50%;
  touch-action: none;
}
#joystickInner {
  position: absolute; width:60px; height:60px; left:30px; top:30px;
  background: rgba(255,255,255,0.5); border-radius:50%;
}

#actionBtn {
  position:absolute; bottom:50px; right:50px; width:80px; height:80px;
  background: rgba(255,0,0,0.5); border-radius:50%;
}
#inventory { position:absolute; top:10px; left:50%; transform:translateX(-50%);
display:flex; gap:5px; background: rgba(0,0,0,0.4); padding:5px; border-radius:5px; }
.block-slot { width:40px; height:40px; display:flex; align-items:center; justify-content:center;
background:#ccc; border:2px solid #888; font-weight:bold; cursor:pointer; }
.selected { border:2px solid yellow; }
</style>
</head>
<body>
<div id="joystick"><div id="joystickInner"></div></div>
<div id="actionBtn"></div>
<div id="inventory"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simplex-noise@3.0.0/simplex-noise.min.js"></script>
<script>

// ---- SETTINGS ----
const BLOCKS = { AIR:0, GRASS:1, DIRT:2, STONE:3, WOOD:4 };
let selectedBlock = BLOCKS.GRASS;

// ---- THREE.JS SETUP ----
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight,0.1,1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Lighting
scene.add(new THREE.AmbientLight(0xffffff,0.7));
const dirLight = new THREE.DirectionalLight(0xffffff,0.6);
dirLight.position.set(5,10,5);
scene.add(dirLight);

// Textures
const loader = new THREE.TextureLoader();
const textures = {
  [BLOCKS.GRASS]: loader.load('https://i.imgur.com/6vXWzCx.png'),
  [BLOCKS.DIRT]: loader.load('https://i.imgur.com/JQ1m8hv.png'),
  [BLOCKS.STONE]: loader.load('https://i.imgur.com/1rVg2gO.png'),
  [BLOCKS.WOOD]: loader.load('https://i.imgur.com/0w6I0c9.png')
};

// ---- PLAYER ----
let player = {x:0,y:10,z:0,velocityY:0,canJump:false,dirX:0,dirZ:0};

// ---- INVENTORY ----
const inventoryDiv = document.getElementById('inventory');
for(let [name,id] of Object.entries(BLOCKS)){
    if(id===0) continue;
    const slot = document.createElement('div');
    slot.className='block-slot'+(id===selectedBlock?' selected':'');
    slot.innerText=name[0];
    slot.onclick=()=>{ selectedBlock=id; document.querySelectorAll('.block-slot').forEach(s=>s.classList.remove('selected')); slot.classList.add('selected'); }
    inventoryDiv.appendChild(slot);
}

// ---- WORLD ----
const world = new THREE.Group(); scene.add(world);
const simplex = new SimplexNoise();
function generateTerrain(size){
    for(let x=-size;x<size;x++){
        for(let z=-size;z<size;z++){
            let height = Math.floor((simplex.noise2D(x/20,z/20)+1)/2*10);
            for(let y=0;y<=height;y++){
                let type = y===height?BLOCKS.GRASS:(y>height-4?BLOCKS.DIRT:BLOCKS.STONE);
                addBlock(x,y,z,type);
            }
        }
    }
}
function addBlock(x,y,z,type){
    if(type===BLOCKS.AIR) return;
    const geo = new THREE.BoxGeometry(1,1,1);
    const mat = new THREE.MeshLambertMaterial({map:textures[type]});
    const mesh = new THREE.Mesh(geo,mat);
    mesh.position.set(x+0.5,y+0.5,z+0.5);
    world.add(mesh);
}
generateTerrain(32);

// ---- JOYSTICK ----
const joystick = document.getElementById('joystick');
const joystickInner = document.getElementById('joystickInner');
let touchStart = null;
joystick.addEventListener('touchstart',e=>{touchStart=e.touches[0];});
joystick.addEventListener('touchmove',e=>{
    e.preventDefault();
    if(!touchStart) return;
    const t = e.touches[0];
    let dx = t.clientX-touchStart.clientX;
    let dz = t.clientY-touchStart.clientY;
    dx=Math.max(-50,Math.min(50,dx));
    dz=Math.max(-50,Math.min(50,dz));
    joystickInner.style.transform=`translate(${dx}px,${dz}px)`;
    player.dirX = dx/50;
    player.dirZ = dz/50;
});
joystick.addEventListener('touchend',e=>{
    joystickInner.style.transform='translate(0,0)';
    player.dirX=0; player.dirZ=0;
    touchStart=null;
});

// ---- CAMERA DRAG ----
let cameraTouch = null;
document.addEventListener('touchstart',e=>{
    if(e.target===joystick || e.target===actionBtn) return;
    cameraTouch = e.touches[0];
});
document.addEventListener('touchmove',e=>{
    if(!cameraTouch) return;
    let t = e.touches[0];
    let dx = t.clientX - cameraTouch.clientX;
    let dy = t.clientY - cameraTouch.clientY;
    yaw -= dx*0.002;
    pitch -= dy*0.002;
    pitch = Math.max(-Math.PI/2,Math.min(Math.PI/2,pitch));
    cameraTouch = t;
});
document.addEventListener('touchend',e=>{
    cameraTouch = null;
});

// ---- ACTION BUTTON ----
const actionBtn = document.getElementById('actionBtn');
let isBreaking=false;
actionBtn.addEventListener('touchstart',e=>isBreaking=true);
actionBtn.addEventListener('touchend',e=>isBreaking=false);

// ---- PLAYER MOVEMENT & GRAVITY ----
function updatePlayer(){
    const speed=0.1;
    let forward = new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
    let right = new THREE.Vector3(Math.sin(yaw+Math.PI/2),0,
    plzayer.z += move.z;
